<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerir Utilizadores</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <h1>Gerir Utilizadores</h1>
            <div class="header-actions">
                <button id="addUserBtn" class="btn btn-success">Adicionar Novo Utilizador</button>
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary" style="text-decoration: none;">Voltar ao Dashboard</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="table-container mt-4">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Cargo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.nome }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.role }}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary btn-sm edit" data-userid="{{ user.id }}">Editar</button>
                            <form action="{{ url_for('main.apagar_usuario', user_id=user.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Tem a certeza que deseja apagar este utilizador?');">
                                <button type="submit" class="btn btn-danger btn-sm">Apagar</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center">Nenhum utilizador encontrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <hr class="my-5">

        <div class="upload-logo-container">
            <h3>Upload de Logo para Relatórios</h3>
            <p class="text-muted">O logo será exibido no canto superior esquerdo dos relatórios de impressão.</p>
            
            <form action="{{ url_for('main.upload_logo') }}" method="post" enctype="multipart/form-data" class="mt-3">
                <div class="mb-3">
                    <label for="logoFile" class="form-label">Selecione o arquivo do logo (PNG, JPG):</label>
                    <input type="file" class="form-control" id="logoFile" name="file" accept=".png, .jpg, .jpeg">
                </div>
                <button type="submit" class="btn btn-primary">Fazer Upload do Logo</button>
            </form>

            {% if current_apartment_logo %}
                <div class="card-body">
                <h4>Logo Atual:</h4>
                {% if current_apartment_logo %}
                    <img src="{{ url_for('static', filename='uploads/' ~ current_apartment_logo) }}" 
                        alt="Logo do Apartamento" 
                        style="max-width: 150px; height: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px;">
                {% else %}
                    <p>Nenhuma logo carregada.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>

    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalTitle">Adicionar Novo Utilizador</h2>
            <form id="userForm" method="POST">
                <input type="hidden" id="userId" name="userId">
                <div class="form-group mb-3">
                    <label for="nome" class="form-label">Nome Completo</label>
                    <input type="text" id="nome" name="nome" class="form-control" required>
                </div>
                <div class="form-group mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                </div>
                <div class="form-group mb-3">
                    <label for="password" class="form-label">Senha</label>
                    <input type="password" id="password" name="password" class="form-control">
                    <small id="passwordHelp" class="form-text text-muted">Deixe em branco para não alterar a senha existente.</small>
                </div>
                <div class="form-group mb-3">
                    <label for="role" class="form-label">Cargo</label>
                    <select id="role" name="role" class="form-select">
                        <option value="usuario">Utilizador</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success float-end">Salvar</button>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('userModal');
    const addUserBtn = document.getElementById('addUserBtn');
    const closeBtn = modal.querySelector('.close-button');
    const userForm = document.getElementById('userForm');
    const modalTitle = document.getElementById('modalTitle');
    const passwordHelp = document.getElementById('passwordHelp');
    const passwordInput = document.getElementById('password');

    addUserBtn.onclick = function() {
        userForm.reset();
        userForm.action = "{{ url_for('main.adicionar_usuario') }}";
        modalTitle.textContent = 'Adicionar Novo Utilizador';
        passwordInput.required = true;
        passwordHelp.style.display = 'none';
        modal.style.display = 'block';
    }

    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    document.querySelectorAll('.edit').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userid;
            const url_get_data = "{{ url_for('main.get_user_data', user_id=0) }}".replace('0', userId);

            fetch(url_get_data)
                .then(response => response.json())
                .then(data => {
                    if(data.error) {
                        alert(data.error);
                        return;
                    }
                    userForm.reset();
                    
                    const url_edit_action = "{{ url_for('main.editar_usuario', user_id=0) }}".replace('0', userId);
                    userForm.action = url_edit_action;
                    modalTitle.textContent = 'Editar Utilizador';
                    
                    document.getElementById('nome').value = data.nome;
                    document.getElementById('email').value = data.email;
                    document.getElementById('role').value = data.role;
                    
                    passwordInput.required = false;
                    passwordHelp.style.display = 'block';
                    
                    modal.style.display = 'block';
                });
        });
    });
});
</script>
</body>
</html>