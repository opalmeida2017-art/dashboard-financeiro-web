{% extends "layout.html" %}

{% block content %}
    <div class="page-container">
        <div class="page-header">
            <h1>Painel do Síndico</h1>
            <div class="header-actions">
                <a href="{{ url_for('main.criar_apartamento') }}" class="btn-salvar" style="text-decoration: none;">Criar Novo Apartamento</a>
            </div>
        </div>

        <div class="table-container">
            <h3>Apartamentos Registados</h3>
            <form method="POST" action="{{ url_for('main.admin_dashboard') }}"> 
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome da Empresa</th>
                            <th>Status</th>
                            <th>Uso de Dados (Registos)</th>
                            <th>Intervalo (min)</th>
                            <th>Link de Acesso do Cliente</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for apt in apartamentos %}
                        <tr>
                            <td>{{ apt.id }}</td>
                            <td>{{ apt.nome_empresa }}</td>
                            <td><span class="status-{{ apt.status }}">{{ apt.status }}</span></td>
                            <td>{{ "{:,.0f}".format(apt.total_registos or 0).replace(",", ".") }}</td>
                            <td>
                                <input type="number" name="interval_{{ apt.id }}" 
                                       value="{{ apt.live_monitoring_interval_minutes }}" 
                                       style="width: 60px; text-align: center;">
                            </td>
                            <td>
                                {% if apt.access_link != "Sem slug definido" %}
                                    <a href="{{ apt.access_link }}" target="_blank" id="link-apt-{{ apt.id }}">{{ apt.access_link }}</a>
                                {% else %}
                                    <span style="color: #888;">{{ apt.access_link }}</span>
                                {% endif %}
                            </td>
                            <td class="actions-cell">
                                <a href="{{ url_for('main.gerir_apartamento', apartamento_id=apt.id) }}" class="btn-action" style="text-decoration: none;">Gerir</a>
                                <button type="button" class="btn-action delete-data-btn" data-apt-id="{{ apt.id }}" style="background-color: #dc3545; color: white;">Limpar Dados</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" style="text-align: center;">Nenhum apartamento encontrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const activeLinks = new Set();

    function updateLinkStatus(activeIds) {
        const allLinks = document.querySelectorAll('a[id^="link-apt-"]');
        
        allLinks.forEach(link => {
            link.style.color = '';
            link.style.fontWeight = 'normal';
        });
        
        activeIds.forEach(id => {
            const activeLink = document.getElementById(`link-apt-${id}`);
            if (activeLink) {
                activeLink.style.color = '#28a745';
                activeLink.style.fontWeight = 'bold';
            }
        });
    }

    console.log("Iniciando conexão com o stream de status do servidor...");
    
    const eventSource = new EventSource('/api/status_stream');

    eventSource.addEventListener('message', function(event) {
        console.log("Recebido update de status:", event.data);
        const data = JSON.parse(event.data);

        if (data.active_apartments) {
            updateLinkStatus(data.active_apartments);
        }
    });

    eventSource.onerror = function(err) {
        console.error("Erro na conexão de streaming. A conexão pode ter sido fechada.", err);
    };

    // Lógica para o novo botão de limpeza
    document.querySelectorAll('.delete-data-btn').forEach(button => {
        button.addEventListener('click', function() {
            const apartamentoId = this.getAttribute('data-apt-id');
            const confirmacao = confirm(`ATENÇÃO: Você tem certeza que deseja limpar TODOS os dados do apartamento ID ${apartamentoId}? Esta ação é irreversível e apagará todos os dados, incluindo os arquivos de download.`);
            
            if (confirmacao) {
                this.disabled = true;
                this.textContent = 'Limpando...';

                fetch(`/super-admin/limpar-dados/${apartamentoId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Dados do apartamento ${apartamentoId} foram limpos com sucesso.`);
                        window.location.reload();
                    } else {
                        alert(`Ocorreu um erro ao limpar os dados: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Ocorreu um erro inesperado.');
                })
                .finally(() => {
                    this.disabled = false;
                    this.textContent = 'Limpar Dados';
                });
            }
        });
    });
});
</script>
{% endblock %}