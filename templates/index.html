<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Transporte</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Dashboard Transporte</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="filters">
        <form method="GET" action="/">
            <label for="start_date">Data In칤cio:</label>
            <input type="date" id="start_date" name="start_date" value="{{ selected_start_date or '' }}">
            <label for="end_date">Data Fim:</label>
            <input type="date" id="end_date" name="end_date" value="{{ selected_end_date or '' }}">
            <label for="placa">Placa:</label>
            <select name="placa" id="placa">
                {% for placa in placas %}
                    <option value="{{ placa }}" {% if placa == selected_placa %}selected{% endif %}>{{ placa }}</option>
                {% endfor %}
            </select>
            <label for="filial">Filial:</label>
            <select name="filial" id="filial">
                {% for filial in filiais %}
                    <option value="{{ filial }}" {% if filial == selected_filial %}selected{% endif %}>{{ filial }}</option>
                {% endfor %}
            </select>
            <button type="submit">Aplicar Filtros</button>
            
            <div class="action-buttons">
                <button type="button" id="openUploadModalBtn" class="upload-link">Fazer Upload</button>
                <button type="button" id="openModalBtn" class="manage-link">Gerenciar Grupos</button>
            </div>
        </form>
    </div>

{% if summary %}
        <div class="summary-cards">
            <div class="card">
                <h3>Faturamento Total</h3>
                <p style="color: #2980B9;">{{ summary.faturamento_total_viagens | currency }}</p>
            </div>
            <div class="card">
                <h3>Custo Total</h3>
                <p style="color: #E67E22;">{{ summary.custo_total_viagem | currency }}</p>
            </div>
            <div class="card">
                <h3>Despesa Gerais</h3>
                <p style="color: #C0392B;">{{ summary.total_despesas_gerais | currency }}</p>
            </div>
            <div class="card">
                <h3>Lucro Liquido</h3>
                <p style="color: {% if summary.saldo_geral >= 0 %}#2ECC71{% else %}#C0392B{% endif %};">
                    {{ summary.saldo_geral | currency }}
                </p>
            </div>
             <div class="card">
                <h3>Margem Frete</h3>
                <p style="color: {% if summary.margem_frete >= 0 %}#2ECC71{% else %}#C0392B{% endif %};">
                    {{ summary.margem_frete | percentage }}
                </p>
            </div>
             <div class="card">
                <h3>Contas a Pagar Pendentes</h3>
                <p style="color: #C0392B;">{{ summary.saldo_contas_a_pagar_pendentes | currency }}</p>
            </div>
            <div class="card">
                <h3>Contas a Receber Pendentes</h3>
                <p style="color: #2980B9;">{{ summary.saldo_contas_a_receber_pendentes | currency }}</p>
            </div>
        </div>
    {% else %}
        <p style="text-align: center;">N칚o h치 dados para exibir. Tente importar os dados ou ajustar os filtros.</p>
    {% endif %}

    <div class="chart-container">
        <h2>Faturamento vs. Despesas (Mensal)</h2>
        <canvas id="faturamentoDespesasChart"></canvas>
    </div>

    <div id="manageGroupsModal" class="modal">
        <div class="modal-content">
            <span class="close-button manage-close">&times;</span>
            <h2>Gerenciar Grupos de Despesa</h2>
            <p>Classifique cada grupo...</p>
            <form method="POST" action="{{ url_for('gerenciar_grupos_salvar') }}">
                <div id="manageGroupsTableContainer">
                    <p>Carregando grupos...</p>
                </div>
                <button type="submit" class="btn-salvar">Salvar Altera칞칫es</button>
            </form>
        </div>
    </div>
    
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close-button upload-close">&times;</span>
            <div id="uploadFormContainer">
                <h2>Upload de Novas Planilhas</h2>
                <p>Selecione uma ou mais planilhas...</p>
                <form id="uploadForm" method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="files">1. Escolha os arquivos no seu computador:</label>
                        <input type="file" name="files[]" id="files" multiple required>
                    </div>
                    <button type="submit" class="btn-salvar">Enviar e Importar</button>
                </form>
            </div>
            <div id="progressContainer" style="display: none;">
                <h4>Processando planilhas... Por favor, aguarde.</h4>
                <div class="progress-road">
                    <div class="progress-bar">
                        <span class="truck-emoji">游뚴</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- L칩gica do Gr치fico ---
        // Constr칩i a URL com os filtros atuais da p치gina.
        const params = new URLSearchParams(window.location.search);
        fetch(`/api/monthly_summary?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    // Ponto Chave 1: Lendo as chaves corretas que o Python envia
                    const labels = data.map(item => item.PeriodoLabel);
                    const faturamentoData = data.map(item => item.Faturamento);
                    const custoData = data.map(item => item.Custo);
                    const despesasGeraisData = data.map(item => item.DespesasGerais);

                    const ctx = document.getElementById('faturamentoDespesasChart').getContext('2d');
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Faturamento',
                                    data: faturamentoData,
                                    backgroundColor: 'rgba(41, 128, 185, 0.7)'
                                },
                                {
                                    label: 'Custo de Viagem',
                                    data: custoData,
                                    backgroundColor: '#E67E22', // Cor laranja
                                    stack: 'GastoOperacional' // Agrupa Custo e Despesa
                                },
                                // Ponto Chave 2: Criando o dataset para a Despesa Geral
                                {
                                    label: 'Despesa Geral',
                                    data: despesasGeraisData,
                                    backgroundColor: 'rgba(192, 57, 43, 0.7)', // Cor vermelha
                                    stack: 'GastoOperacional' // Agrupa Custo e Despesa
                                }
                            ]
                        },
                        options: {
                            scales: {
                                x: {
                                    stacked: true,
                                },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return 'R$ ' + value.toLocaleString('pt-BR');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Erro ao buscar dados para o gr치fico:', error));

        // --- L칩gica dos Popups (Modals) ---
 // L칩gica do Popup (Modal) de Gerenciamento - VERS츾O CORRETA COM CHECKBOXES
const manageModal = document.getElementById('manageGroupsModal');
const manageBtn = document.getElementById('openModalBtn');
const manageCloseBtn = document.querySelector('.manage-close');
const tableContainer = document.getElementById('manageGroupsTableContainer');

if (manageBtn) {
    manageBtn.onclick = function() {
        tableContainer.innerHTML = '<p>Sincronizando e carregando grupos...</p>';
        manageModal.style.display = 'block';

        fetch("{{ url_for('gerenciar_grupos_dados') }}")
            .then(response => response.json())
            .then(flags => {
                let tableHTML = `
                    <table>
                        <thead>
                            <tr> <th>Nome do Grupo de Despesa</th> <th>Classifica칞칚o</th> </tr>
                        </thead>
                        <tbody>`;
                
                for (const group in flags) {
                    const isCustoChecked = flags[group].is_custo_viagem === 'S' ? 'checked' : '';
                    const isDespesaChecked = flags[group].is_despesa === 'S' ? 'checked' : '';
                    // VOLTANDO A USAR CHECKBOXES
                    tableHTML += `
                        <tr>
                            <td>${group}</td>
                            <td>
                                <label><input type="checkbox" class="classification-cb" data-group="${group}" data-type="custo" name="${group}_custo" ${isCustoChecked}> 칄 um Custo de Viagem</label><br>
                                <label><input type="checkbox" class="classification-cb" data-group="${group}" data-type="despesa" name="${group}_despesa" ${isDespesaChecked}> 칄 uma Despesa Geral</label>
                            </td>
                        </tr>`;
                }

                tableHTML += '</tbody></table>';
                tableContainer.innerHTML = tableHTML;
                
                // Esta fun칞칚o 칠 necess치ria para que os checkboxes sejam exclusivos
                setupExclusiveCheckboxes();
            });
    }
}
if (manageCloseBtn) { manageCloseBtn.onclick = function() { manageModal.style.display = 'none'; } }

// Fun칞칚o que garante que apenas um checkbox por grupo possa ser marcado
function setupExclusiveCheckboxes() {
    const checkboxes = document.querySelectorAll('.classification-cb');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            if (this.checked) {
                const currentGroup = this.dataset.group;
                const currentType = this.dataset.type;
                checkboxes.forEach(otherCb => {
                    if (otherCb.dataset.group === currentGroup && otherCb.dataset.type !== currentType) {
                        otherCb.checked = false;
                    }
                });
            }
        });
    });
}
        
        const uploadModal = document.getElementById('uploadModal');
        const uploadBtn = document.getElementById('openUploadModalBtn');
        const uploadCloseBtn = document.querySelector('.upload-close');
        if(uploadBtn) { uploadBtn.onclick = function() { uploadModal.style.display = 'block'; } }
        if(uploadCloseBtn) { uploadCloseBtn.onclick = function() { uploadModal.style.display = 'none'; } }
        
        window.addEventListener('click', function(event) {
            if (event.target == manageModal) { manageModal.style.display = 'none'; }
            if (event.target == uploadModal) { uploadModal.style.display = 'none'; }
        });
        
        const uploadForm = document.getElementById('uploadForm');
        const uploadFormContainer = document.getElementById('uploadFormContainer');
        const progressContainer = document.getElementById('progressContainer');

        if (uploadForm) {
            uploadForm.addEventListener('submit', function() {
                uploadFormContainer.style.display = 'none';
                progressContainer.style.display = 'block';
            });
        }
    });
</script>
</body>
</html>