{% extends "layout.html" %}

{% block content %}
    <h1>Dashboard Transporte</h1>

<div class="filters">
    <form method="GET" action="/">
        <label for="start_date">Data In√≠cio:</label>
        <input type="date" id="start_date" name="start_date" value="{{ selected_start_date or '' }}">
        
        <label for="end_date">Data Fim:</label>
        <input type="date" id="end_date" name="end_date" value="{{ selected_end_date or '' }}">
        
        <label for="placa">Placa:</label>
        <select name="placa" id="placa">
            {% for placa in placas %}
                <option value="{{ placa }}" {% if placa == selected_placa %}selected{% endif %}>{{ placa }}</option>
            {% endfor %}
        </select> <div class="form-group">
            <label for="filial-multiselect-btn">Filial:</label>
            <div class="multiselect" id="filial-multiselect">
                <button type="button" class="multiselect-btn" id="filial-multiselect-btn">
                    Selecionar Filiais
                </button>
                <div class="multiselect-dropdown" id="filial-dropdown">
                    {% for filial in filiais %}
                        {% if filial != "Todos" %}
                        <div class="multiselect-item">
                            <input type="checkbox" name="filial" value="{{ filial }}" id="filial-{{ loop.index }}"
                                   {% if filial in selected_filial %}checked{% endif %}>
                            <label for="filial-{{ loop.index }}">{{ filial }}</label>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <button type="submit">Aplicar Filtros</button>
        
        <div class="action-buttons">
            <button type="button" id="openUploadModalBtn" class="upload-link">Fazer Upload</button>
            <button type="button" id="openModalBtn" class="manage-link">Gerenciar Grupos</button>

            {% if is_admin_in_context() %}
                <a href="{{ url_for('gerenciar_usuarios') }}" class="manage-link">Gerir Utilizadores</a>
            {% endif %}
            
            <a href="{{ url_for('configuracao') }}" class="config-link" style="padding: 8px 12px; background-color: #ffc107; color: black; text-decoration: none; border-radius: 4px; font-weight: 500;">Configurar Rob√¥</a>
            <button type="button" id="btn-iniciar-coleta" class="run-automation-link" style="padding: 8px 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">Atualizar Dados</button>
        </div>
    </form>
</div>

    {% if summary %}
    <div class="summary-cards">
        <div class="card card-com-link-hover">
            <a href="#" id="link-detalhes-superior" class="link-detalhes-container">
                An√°lise Detalhada de Faturamento &rarr;
            </a>
            <a href="#" id="link-detalhes-faturamento" style="text-decoration: none; color: inherit;">
                <h3>Faturamento Total</h3>
                <p style="color: #2980B9;">{{ summary.faturamento_total_viagens | currency }}</p>
            </a>
        </div>
        <div class="card">
            <h3>Custo Total</h3>
            <p style="color: #E67E22;">{{ summary.custo_total_viagem | currency }}</p>
        </div>
        <div class="card">
            <h3>Despesa Gerais</h3>
            <p style="color: #C0392B;">{{ summary.total_despesas_gerais | currency }}</p>
        </div>
        <div class="card">
            <h3>Lucro Liquido</h3>
            <p style="color: {% if summary.saldo_geral >= 0 %}#2ECC71{% else %}#C0392B{% endif %};">{{ summary.saldo_geral | currency }}</p>
        </div>
        <div class="card">
            <h3>Margem Frete</h3>
            <p style="color: {% if summary.margem_frete >= 0 %}#2ECC71{% else %}#C0392B{% endif %};">{{ summary.margem_frete | percentage }}</p>
        </div>
        <div class="card">
            <h3>Contas a Pagar Pendentes</h3>
            <p style="color: #C0392B;">{{ summary.saldo_contas_a_pagar_pendentes | currency }}</p>
        </div>
        <div class="card">
            <h3>Contas a Receber Pendentes</h3>
            <p style="color: #2980B9;">{{ summary.saldo_contas_a_receber_pendentes | currency }}</p>
        </div>
    </div>
    {% else %}
        <p style="text-align: center;">N√£o h√° dados para exibir. Tente importar os dados ou ajustar os filtros.</p>
    {% endif %}

    <div class="chart-container" id="secao-grafico">
        <h2>Faturamento vs. Despesas (Mensal/Di√°rio)</h2>
        <canvas id="faturamentoDespesasChart"></canvas>
    </div>

    <div id="manageGroupsModal" class="modal">
        <div class="modal-content">
            <span class="close-button manage-close">&times;</span>
            <h2>Gerenciar Grupos de Despesa</h2>
            <p>Classifique cada grupo...</p>
            <form method="POST" action="{{ url_for('gerenciar_grupos_salvar') }}">
                <div id="manageGroupsTableContainer"><p>Carregando grupos...</p></div>
                <button type="submit" class="btn-salvar">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>
    
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close-button upload-close">&times;</span>
            <div id="uploadFormContainer">
                <h2>Upload de Novas Planilhas</h2>
                <p>Selecione uma ou mais planilhas...</p>
                <form id="uploadForm" method="POST" action="/upload" enctype="multipart/form-data">                    
    <div class="form-group">
                        <label for="files">1. Escolha os arquivos no seu computador:</label>
                        <input type="file" name="files[]" id="files" multiple required>
                    </div>
                    <button type="submit" class="btn-salvar">Enviar e Importar</button>
                </form>
            </div>
            <div id="progressContainer" style="display: none;">
                <h4>Processando planilhas... Por favor, aguarde.</h4>
                <div class="progress-road">
                    <div class="progress-bar">
                        <span class="truck-emoji">üöö</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
<script>
    // Todo o JavaScript que √© espec√≠fico para a p√°gina index.html vai aqui
    document.addEventListener('DOMContentLoaded', function () {
        
        // --- L√ìGICA DO GR√ÅFICO ---
        const params = new URLSearchParams(window.location.search);
        const chartCanvas = document.getElementById('faturamentoDespesasChart');
        if (chartCanvas) {
            fetch(`/api/monthly_summary?${params.toString()}`)
                .then(response => {
                    if (!response.ok) { throw new Error('Erro na resposta da rede.'); }
                    return response.json();
                })
                .then(data => {
                    const chartContainer = document.getElementById('secao-grafico');
                    if (!data || data.length === 0) {
                        if(chartContainer) {
                            chartContainer.innerHTML = '<h2>Faturamento vs. Despesas (Mensal/Di√°rio)</h2><p style="text-align: center; padding-top: 20px;">Nenhum dado dispon√≠vel para o per√≠odo selecionado.</p>';
                        }
                        return; 
                    }

                    const labels = data.map(item => item.PeriodoLabel);
                    const faturamentoData = data.map(item => item.Faturamento);
                    const custoData = data.map(item => item.Custo);
                    const despesasGeraisData = data.map(item => item.DespesasGerais);
                    
                    const ctx = chartCanvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { 
                                    label: 'Faturamento', 
                                    data: faturamentoData, 
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    stack: 'grupoFaturamento'
                                },
                                { 
                                    label: 'Custo de Viagem', 
                                    data: custoData, 
                                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                                    stack: 'grupoCustos'
                                },
                                { 
                                    label: 'Despesa Geral', 
                                    data: despesasGeraisData, 
                                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                    stack: 'grupoCustos'
                                }
                            ]
                        },
                        options: { 
                            scales: { 
                                x: { stacked: false },
                                y: { stacked: true } 
                            } 
                        }
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar ou processar dados para o gr√°fico:', error);
                    const chartContainer = document.getElementById('secao-grafico');
                    if(chartContainer) {
                        chartContainer.innerHTML = '<h2>Faturamento vs. Despesas (Mensal/Di√°rio)</h2><p style="text-align: center; color: red; padding-top: 20px;">Ocorreu um erro ao carregar os dados do gr√°fico.</p>';
                    }
                });
        }

        // --- L√ìGICA PARA OS LINKS DA NOVA P√ÅGINA ---
        const detalhesLink = document.getElementById('link-detalhes-faturamento');
        if (detalhesLink) {
            const paramsLink = new URLSearchParams(window.location.search);
            detalhesLink.href = `{{ url_for('faturamento_detalhes') }}?${paramsLink.toString()}`;
        }
        const linkSuperior = document.getElementById('link-detalhes-superior');
        if (linkSuperior) {
            const paramsSuperior = new URLSearchParams(window.location.search);
            linkSuperior.href = `{{ url_for('faturamento_detalhes') }}?${paramsSuperior.toString()}`;
        }
        
        // --- L√ìGICA DOS POPUPS (MODAIS) ---
        const manageModal = document.getElementById('manageGroupsModal');
        const manageBtn = document.getElementById('openModalBtn');
        const manageCloseBtn = document.querySelector('.manage-close');
        const tableContainer = document.getElementById('manageGroupsTableContainer');

        if (manageBtn) {
            manageBtn.onclick = function() {
                tableContainer.innerHTML = '<p>Sincronizando e carregando grupos...</p>';
                manageModal.style.display = 'block';
                fetch("{{ url_for('gerenciar_grupos_dados') }}")
                    .then(response => response.json())
                    .then(flags => {
                        let tableHTML = `<table><thead><tr><th>Nome do Grupo de Despesa</th><th>Classifica√ß√£o</th></tr></thead><tbody>`;
                        for (const group in flags) {
                            const isCustoChecked = flags[group].is_custo_viagem === 'S' ? 'checked' : '';
                            const isDespesaChecked = flags[group].is_despesa === 'S' ? 'checked' : '';
                            tableHTML += `<tr><td>${group}</td><td>
                                <label><input type="checkbox" class="classification-cb" data-group="${group}" data-type="custo" name="${group}_custo" ${isCustoChecked}> √â um Custo de Viagem</label><br>
                                <label><input type="checkbox" class="classification-cb" data-group="${group}" data-type="despesa" name="${group}_despesa" ${isDespesaChecked}> √â uma Despesa Geral</label>
                            </td></tr>`;
                        }
                        tableHTML += '</tbody></table>';
                        tableContainer.innerHTML = tableHTML;
                        setupExclusiveCheckboxes();
                    });
            }
        }
        if (manageCloseBtn) { manageCloseBtn.onclick = function() { manageModal.style.display = 'none'; } }

        function setupExclusiveCheckboxes() {
            const checkboxes = document.querySelectorAll('.classification-cb');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.checked) {
                        const currentGroup = this.dataset.group;
                        const currentType = this.dataset.type;
                        checkboxes.forEach(otherCb => {
                            if (otherCb.dataset.group === currentGroup && otherCb.dataset.type !== currentType) {
                                otherCb.checked = false;
                            }
                        });
                    }
                });
            });
        }
        
        const uploadModal = document.getElementById('uploadModal');
        const uploadBtn = document.getElementById('openUploadModalBtn');
        const uploadCloseBtn = document.querySelector('.upload-close');
        if(uploadBtn) { uploadBtn.onclick = function() { uploadModal.style.display = 'block'; } }
        if(uploadCloseBtn) { uploadCloseBtn.onclick = function() { uploadModal.style.display = 'none'; } }
        
        window.addEventListener('click', function(event) {
            if (event.target == manageModal) { manageModal.style.display = 'none'; }
            if (event.target == uploadModal) { uploadModal.style.display = 'none'; }
        });
        
        const uploadForm = document.getElementById('uploadForm');
        const uploadFormContainer = document.getElementById('uploadFormContainer');
        const progressContainer = document.getElementById('progressContainer');

        if (uploadForm) {
            uploadForm.addEventListener('submit', function() {
                uploadFormContainer.style.display = 'none';
                progressContainer.style.display = 'block';
            });
        }

        const btnColeta = document.getElementById('btn-iniciar-coleta');
        if (btnColeta) {
            btnColeta.addEventListener('click', function() {
                if (confirm('Isso iniciar√° a busca autom√°tica por novos relat√≥rios. O processo pode levar alguns minutos. Deseja continuar?')) {
                    btnColeta.disabled = true;
                    btnColeta.textContent = 'Atualizando...';
                    fetch('/iniciar-coleta', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.mensagem);
                            alert("A p√°gina ser√° recarregada em aproximadamente 3 minutos para exibir os dados atualizados. Por favor, aguarde.");
                            setTimeout(() => {
                                window.location.reload();
                            }, 180000); // 3 minutos
                        })
                        .catch(error => {
                            console.error('Erro ao iniciar a coleta:', error);
                            alert('Ocorreu um erro ao tentar iniciar a coleta. O bot√£o foi reativado.');
                            btnColeta.disabled = false;
                            btnColeta.textContent = 'Atualizar Dados';
                        });
                }
            });
        }
    const multiselect = document.getElementById('filial-multiselect');
        
    if (multiselect) {
        const btn = document.getElementById('filial-multiselect-btn');
        const dropdown = document.getElementById('filial-dropdown');
        const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');

        function updateButtonText() {
            const checkedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
            const checkedCount = checkedCheckboxes.length;
            
            if (checkedCount === 0) {
                btn.textContent = 'Selecionar Filiais';
            } else if (checkedCount === 1) {
                btn.textContent = checkedCheckboxes[0].value;
            } else if (checkedCount === checkboxes.length) {
                btn.textContent = 'Todas as filiais';
            } else {
                btn.textContent = `${checkedCount} filiais selecionadas`;
            }
        }

        btn.addEventListener('click', function(event) {
            dropdown.classList.toggle('show');
            event.stopPropagation();
        });

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateButtonText);
        });

        window.addEventListener('click', function(event) {
            if (dropdown.classList.contains('show') && !multiselect.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        updateButtonText(); // Garante o texto correto ao carregar a p√°gina
    }

    });
</script>
{% endblock %}