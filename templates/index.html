{% extends "layout.html" %}

{% block content %}
<style>
    .placa-pr칩prio { color: #2980B9; font-weight: bold; }
    .placa-terceiro { color: #27AE60; }
    .placa-agregado { color: #F39C12; }
    .placa-apoio { color: #8E44AD; font-style: italic; }

    /* --- C칍DIGO ACRESCENTADO: ESTILOS PARA OS NOVOS MODAIS --- */
    .choice-modal-body { text-align: center; padding: 20px; }
    .choice-modal-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
    .choice-modal-buttons button { padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; background-color: #f9f9f9; transition: background-color 0.2s; }
    .choice-modal-buttons button:hover { background-color: #e9e9e9; }
    .choice-modal-buttons .btn-primary { background-color: #007bff; color: white; border-color: #007bff; }
    .choice-modal-buttons .btn-primary:hover { background-color: #0056b3; }
    .conhecimentos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; max-height: 400px; overflow-y: auto; }
    .conhecimento-item { background-color: #f2f2f2; padding: 5px; text-align: center; border-radius: 4px; font-weight: 500; font-size: 0.9em; }
    /* --- FIM DO C칍DIGO ACRESCENTADO --- */

    /* Estilos para o novo modal de auditoria de despesas */
.despesas-audit-modal-body {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* TR칅S colunas */
    gap: 15px;
    padding: 15px;
}
.audit-section {
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    padding: 10px;
    background-color: #f9f9f9;
}
.audit-section h5 {
    margin-top: 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #ccc;
    font-size: 1em;
}
.audit-list {
    max-height: 300px;
    overflow-y: auto;
    font-size: 0.85em;
}
.audit-group h6 {
    font-weight: bold;
    margin-top: 10px;
    margin-bottom: 5px;
}
.audit-key-list {
    list-style-type: none;
    padding-left: 10px;
}
.audit-key-list li {
    padding: 2px 0;
}

/* Cole este c칩digo dentro da tag <style> no topo do seu index.html */
.conhecimento-item { 
    background-color: #f2f2f2; 
    padding: 5px; 
    text-align: center; 
    border-radius: 4px; 
    font-weight: 500; 
    font-size: 0.9em;
    cursor: pointer; /* ESSENCIAL: Muda o cursor do mouse para a 'm칚ozinha' */
    transition: background-color 0.2s, transform 0.2s;
}
.conhecimento-item:hover {
    background-color: #d0e3f0; /* Muda a cor de fundo ao passar o mouse */
    transform: scale(1.05); /* Efeito de zoom sutil */
    font-weight: bold;
}
</style>
    <h1>Dashboard Transporte</h1>

<div class="filters">
    <form method="GET" action="/">
        <div class="filter-item">
            <label for="start_date">Data In칤cio:</label>
            <input type="date" id="start_date" name="start_date" value="{{ selected_start_date or '' }}">
        </div>
        <div class="filter-item">
            <label for="end_date">Data Fim:</label>
            <input type="date" id="end_date" name="end_date" value="{{ selected_end_date or '' }}">
        </div>
        <div class="filter-item">
            <label for="placa">Placa:</label>
            <select name="placa" id="placa">
                <option value="Todos" {% if 'Todos' == selected_placa %}selected{% endif %}>Todos</option>
                {% for item in placas %}
                    <option value="{{ item.placa }}" class="placa-{{ item.tipo | lower }}" {% if item.placa == selected_placa %}selected{% endif %}>
                        {{ item.placa }} ({{ item.tipo }})
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-item">
            <label for="tipo_negocio">Tipo de Neg칩cio:</label>
            <select name="tipo_negocio" id="tipo_negocio">
                <option value="Todos" {% if 'Todos' == selected_tipo_negocio %}selected{% endif %}>Todos</option>
                {% for tipo in tipos_negocio %}
                    <option value="{{ tipo }}" {% if tipo == selected_tipo_negocio %}selected{% endif %}>
                        {{ tipo }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-item">
            <label for="filial-multiselect-btn">Filial:</label>
            <div class="multiselect" id="filial-multiselect">
                <button type="button" class="multiselect-btn" id="filial-multiselect-btn">
                    Selecionar Filiais
                </button>
                <div class="multiselect-dropdown" id="filial-dropdown">
                    {% for filial in filiais %}
                        {% if filial != "Todos" %}
                        <div class="multiselect-item">
                            <input type="checkbox" name="filial" value="{{ filial }}" id="filial-{{ loop.index }}"
                                   {% if filial in selected_filial %}checked{% endif %}>
                            <label for="filial-{{ loop.index }}">{{ filial }}</label>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="filter-item">
            <button type="submit">Aplicar Filtros</button>
        </div>
        <div class="action-buttons">
            <button type="button" id="openUploadModalBtn" class="upload-link">Fazer Upload</button>
            <button type="button" id="openModalBtn" class="manage-link">Gerenciar Grupos</button>
            {% if is_admin_in_context() %}
                <a href="{{ url_for('main.gerenciar_usuarios') }}" class="manage-link">Gerir Utilizadores</a>
            {% endif %}
            <a href="{{ url_for('main.configuracao') }}" class="config-link" style="padding: 8px 12px; background-color: #ffc107; color: black; text-decoration: none; border-radius: 4px; font-weight: 500;">Configurar Rob칪</a>
            <button type="button" id="btn-iniciar-coleta" class="run-automation-link" style="padding: 8px 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">Atualizar Dados</button>
        </div>
    </form>
</div>

    {% if summary %}
    <div class="summary-cards">
        <div class="card card-com-link-hover" data-type="faturamento">
            <a href="#" id="link-detalhes-superior" class="link-detalhes-container">
                An치lise Detalhada de Faturamento &rarr;
            </a>
            <a href="#" id="link-detalhes-faturamento" style="text-decoration: none; color: inherit;">
                <h3>Faturamento Total</h3>
                <p style="color: #2980B9;">{{ summary.faturamento_total_viagens | currency }}</p>
            </a>
        </div>
        <div class="card">
            <h3>Custo Total</h3>
            <p style="color: #E67E22;">{{ summary.custo_total_viagem | currency }}</p>
        </div>
        <div class="card card-com-link-hover" data-type="despesas" style="cursor: pointer;">
            <a href="#" id="link-detalhes-superior-despesas" class="link-detalhes-container">
                An치lise Detalhada de Despesa &rarr;
            </a>
            <a href="#" id="link-detalhes-despesas" style="text-decoration: none; color: inherit;">
                <h3>Despesa Gerais</h3>
                <p style="color: #C0392B;">{{ summary.total_despesas_gerais | currency }}</p>
            </a>
        </div>
        <div class="card">
            {% if placa_filtrada %}
                <h3 title="Valor total de Despesas Tipo D dividido pelo n칰mero de ve칤culos pr칩prios.">Despesa Rateada</h3>
            {% else %}
                <h3>Despesas Tipo D</h3>
            {% endif %}
            <p style="color: #8E44AD;">{{ summary.total_despesas_tipo_d | currency }}</p>
        </div>
        <div class="card">
            <h3>Lucro Liquido</h3>
            <p style="color: {% if summary.saldo_geral >= 0 %}#2ECC71{% else %}#C0392B{% endif %};">{{ summary.saldo_geral | currency }}</p>
        </div>
        <div class="card">
            <h3>Margem Frete</h3>
            <p style="color: {% if summary.margem_frete >= 0 %}#2ECC71{% else %}#C0392B{% endif %};">{{ summary.margem_frete | percentage }}</p>
        </div>
        <div class="card">
            <h3>Contas a Pagar Pendentes</h3>
            <p style="color: #C0392B;">{{ summary.saldo_contas_a_pagar_pendentes | currency }}</p>
        </div>
        <div class="card">
            <h3>Contas a Receber Pendentes</h3>
            <p style="color: #2980B9;">{{ summary.saldo_contas_a_receber_pendentes | currency }}</p>
        </div>
    </div>

    <div id="choiceModal" class="modal">
        <div class="modal-content">
            <span class="close-button choice-close">&times;</span>
            <div class="choice-modal-body">
                <h2>O que voc칡 deseja fazer?</h2>
                <div class="choice-modal-buttons">
                    <button id="btnVerGrafico" class="btn-primary">游늵 Ver Gr치fico Detalhado</button>
                    <button id="btnAuditar">游댌 Auditar</button>
                </div>
            </div>
        </div>
    </div>
    <div id="conhecimentosModal" class="modal">
        <div class="modal-content">
            <span class="close-button conhecimentos-close">&times;</span>
            <h2>Conhecimentos do Faturamento</h2>
            <p>Esta 칠 a lista de todos os conhecimentos (CT-es) que comp칫em o valor total de faturamento para os filtros selecionados.</p>
            <div id="conhecimentos-lista" class="conhecimentos-grid"></div>
        </div>
    </div>
    </div>
</div>

    <div 
    id="relatorioViagemModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-button relatorio-close">&times;</span>
            <div id="relatorio-body">
                </div>
        </div>
    </div>
    <div id="despesasAuditModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="close-button despesas-audit-close">&times;</span>
        <h2>Auditoria Detalhada de Despesas</h2>
        <div id="despesas-audit-body" class="despesas-audit-modal-body">
            <div class="audit-section">
                <h5>Custos de Viagem</h5>
                <div id="audit-list-custos" class="audit-list"><p>Carregando...</p></div>
            </div>
            <div class="audit-section">
                <h5>Despesas Gerais</h5>
                <div id="audit-list-despesas" class="audit-list"><p>Carregando...</p></div>
            </div>
            <div class="audit-section">
                <h5>Despesas Tipo D</h5>
                <div id="audit-list-tipo-d" class="audit-list"><p>Carregando...</p></div>
            </div>
        </div>
    </div>
</div>
    {% else %}
        <p style="text-align: center;">N칚o h치 dados para exibir. Tente importar os dados ou ajustar os filtros.</p>
    {% endif %}

    <div class="chart-container" id="secao-grafico">
        <h2>Faturamento vs. Despesas (Mensal/Di치rio)</h2>
        <canvas id="faturamentoDespesasChart"></canvas>
    </div>

    <div id="manageGroupsModal" class="modal">
        <div class="modal-content">
            <span class="close-button manage-close">&times;</span>
            <h2>Gerenciar Grupos de Despesa</h2>
            <p>Classifique cada grupo...</p>
           <form method="POST" action="{{ url_for('main.gerenciar_grupos_salvar') }}">                <div id="manageGroupsTableContainer"><p>Carregando grupos...</p></div>
                <button type="submit" class="btn-salvar">Salvar Altera칞칫es</button>
            </form>
        </div>
    </div>
    
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close-button upload-close">&times;</span>
            <div id="uploadFormContainer">
                <h2>Upload de Novas Planilhas</h2>
                <p>Selecione uma ou mais planilhas...</p>
                <form id="uploadForm" method="POST" action="/upload" enctype="multipart/form-data">                    
                    <div class="form-group">
                        <label for="files">1. Escolha os arquivos no seu computador:</label>
                        <input type="file" name="files[]" id="files" multiple required>
                    </div>
                    <button type="submit" class="btn-salvar">Enviar e Importar</button>
                </form>
            </div>
            <div id="progressContainer" style="display: none;">
                <h4>Processando planilhas... Por favor, aguarde.</h4>
                <div class="progress-road">
                    <div class="progress-bar">
                        <span class="truck-emoji">游뚴</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- L칍GICA GERAL DA P츼GINA ---
        const params = new URLSearchParams(window.location.search);

        // Valida칞칚o de data
        const filterForm = document.querySelector('.filters form');
        if (filterForm) {
            filterForm.addEventListener('submit', function(event) {
                const startDateValue = document.getElementById('start_date').value;
                const endDateValue = document.getElementById('end_date').value;
                if (startDateValue && endDateValue && startDateValue > endDateValue) {
                    event.preventDefault();
                    alert('Aten칞칚o: A data inicial n칚o pode ser maior que a data final.');
                }
            });
        }
        
        // L칩gica do gr치fico principal
        const chartCanvas = document.getElementById('faturamentoDespesasChart');
        if (chartCanvas) {
            fetch(`/api/monthly_summary?${params.toString()}`)
                .then(response => response.ok ? response.json() : Promise.reject('Erro de rede'))
                .then(data => {
                    const chartContainer = document.getElementById('secao-grafico');
                    if (!data || data.length === 0) {
                        if(chartContainer) chartContainer.innerHTML = '<h2>Faturamento vs. Despesas (Mensal/Di치rio)</h2><p style="text-align: center; padding-top: 20px;">Nenhum dado dispon칤vel para o per칤odo selecionado.</p>';
                        return; 
                    }
                    const labels = data.map(item => item.PeriodoLabel);
                    const faturamentoData = data.map(item => item.Faturamento);
                    const custoData = data.map(item => item.Custo);
                    const despesasGeraisData = data.map(item => item.DespesasGerais);
                    new Chart(chartCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Faturamento', data: faturamentoData, backgroundColor: 'rgba(54, 162, 235, 0.7)', stack: 'grupoFaturamento' },
                                { label: 'Custo de Viagem', data: custoData, backgroundColor: 'rgba(255, 159, 64, 0.7)', stack: 'grupoCustos' },
                                { label: 'Despesa Geral', data: despesasGeraisData, backgroundColor: 'rgba(255, 99, 132, 0.7)', stack: 'grupoCustos' }
                            ]
                        },
                        options: { scales: { x: { stacked: false }, y: { stacked: true } } }
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar ou processar dados para o gr치fico:', error);
                    const chartContainer = document.getElementById('secao-grafico');
                    if(chartContainer) chartContainer.innerHTML = '<h2>Faturamento vs. Despesas (Mensal/Di치rio)</h2><p style="text-align: center; color: red; padding-top: 20px;">Ocorreu um erro ao carregar os dados do gr치fico.</p>';
                });
        }

        // --- L칍GICA DOS MODAIS (GERAL) ---
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            const closeButton = modal.querySelector('.close-button');
            if (closeButton) {
                closeButton.onclick = () => modal.style.display = 'none';
            }
        });
        window.addEventListener('click', (event) => {
            modals.forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        });
        
        // Modal de Gerenciar Grupos
        const manageModal = document.getElementById('manageGroupsModal');
        const manageBtn = document.getElementById('openModalBtn');
        if (manageBtn) {
            manageBtn.onclick = function() {
                const tableContainer = document.getElementById('manageGroupsTableContainer');
                tableContainer.innerHTML = '<p>Sincronizando e carregando grupos...</p>';
                manageModal.style.display = 'block';
                fetch("{{ url_for('main.gerenciar_grupos_dados') }}")
                    .then(response => response.json())
                    .then(flags => {
                        let tableHTML = `<table><thead><tr><th>Nome do Grupo de Despesa</th><th>Classifica칞칚o</th></tr></thead><tbody>`;
                        for (const group in flags) {
                            const isCustoChecked = flags[group].is_custo_viagem === 'S' ? 'checked' : '';
                            const isDespesaChecked = flags[group].is_despesa === 'S' ? 'checked' : '';
                            const isTipoDChecked = flags[group].incluir_em_tipo_d ? 'checked' : '';
                            const hasTipoD = flags[group].has_tipo_d;
                            let tipoDCheckboxHTML = '';
                            if (hasTipoD) {
                                tipoDCheckboxHTML = `<br><label style="color: #8E44AD; font-weight: bold;"><input type="checkbox" name="${group}_tipo_d" ${isTipoDChecked}> Contabilizar em Tipo D</label>`;
                            }
                            tableHTML += `<tr><td>${group}</td><td>
                                <label><input type="checkbox" class="classification-cb" data-group="${group}" data-type="custo" name="${group}_custo" ${isCustoChecked}> 칄 um Custo de Viagem</label><br>
                                <label><input type="checkbox" class="classification-cb" data-group="${group}" data-type="despesa" name="${group}_despesa" ${isDespesaChecked}> 칄 uma Despesa Geral</label>
                                ${tipoDCheckboxHTML}
                            </td></tr>`;
                        }
                        tableHTML += '</tbody></table>';
                        tableContainer.innerHTML = tableHTML;
                        
                        const checkboxes = document.querySelectorAll('.classification-cb');
                        checkboxes.forEach(cb => {
                            cb.addEventListener('change', function() {
                                if (this.checked) {
                                    const currentGroup = this.dataset.group;
                                    const currentType = this.dataset.type;
                                    checkboxes.forEach(otherCb => {
                                        if (otherCb.dataset.group === currentGroup && otherCb.dataset.type !== currentType) {
                                            otherCb.checked = false;
                                        }
                                    });
                                }
                            });
                        });
                    });
            }
        }

        // Modal de Upload
        const uploadModal = document.getElementById('uploadModal');
        const uploadBtn = document.getElementById('openUploadModalBtn');
        if (uploadBtn) uploadBtn.onclick = () => uploadModal.style.display = 'block';
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function() {
                document.getElementById('uploadFormContainer').style.display = 'none';
                document.getElementById('progressContainer').style.display = 'block';
            });
        }

        // Bot칚o de Iniciar Coleta
        const btnColeta = document.getElementById('btn-iniciar-coleta');
        if (btnColeta) {
            btnColeta.addEventListener('click', function() {
                if (confirm('Isso iniciar치 a busca autom치tica por novos relat칩rios. O processo pode levar alguns minutos. Deseja continuar?')) {
                    btnColeta.disabled = true;
                    btnColeta.textContent = 'Atualizando...';
                    fetch('/iniciar-coleta', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.mensagem + " A p치gina ser치 recarregada para exibir os dados atualizados.");
                            window.location.reload();
                        })
                        .catch(error => {
                            console.error('Erro ao iniciar a coleta:', error);
                            alert('Ocorreu um erro ao tentar iniciar a coleta.');
                            btnColeta.disabled = false;
                            btnColeta.textContent = 'Atualizar Dados';
                        });
                }
            });
        }
        
        // L칩gica do filtro multi-select
        const multiselect = document.getElementById('filial-multiselect');
        if (multiselect) {
            const btn = document.getElementById('filial-multiselect-btn');
            const dropdown = document.getElementById('filial-dropdown');
            const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
            
            function updateButtonText() {
                const checkedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
                const checkedCount = checkedCheckboxes.length;
                if (checkedCount === 0) btn.textContent = 'Selecionar Filiais';
                else if (checkedCount === 1) btn.textContent = checkedCheckboxes[0].value;
                else if (checkedCount === checkboxes.length) btn.textContent = 'Todas as filiais';
                else btn.textContent = `${checkedCount} filiais selecionadas`;
            }

            btn.addEventListener('click', function(event) {
                dropdown.classList.toggle('show');
                event.stopPropagation();
            });
            checkboxes.forEach(checkbox => checkbox.addEventListener('change', updateButtonText));
            
            window.addEventListener('click', function(event) {
                if (dropdown.classList.contains('show') && !multiselect.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
            updateButtonText();
        }

        // L칩gica dos modais de auditoria
        const choiceModal = document.getElementById('choiceModal');
        const conhecimentosModal = document.getElementById('conhecimentosModal');
        const despesasAuditModal = document.getElementById('despesasAuditModal');
        const relatorioModal = document.getElementById('relatorioViagemModal');
        
        if (choiceModal && conhecimentosModal && despesasAuditModal) {
            const btnVerGrafico = choiceModal.querySelector('#btnVerGrafico');
            const btnAuditar = choiceModal.querySelector('#btnAuditar');
            
            const urlGraficoFaturamento = `{{ url_for('main.faturamento_detalhes') }}?${params.toString()}`;            
            const urlGraficoDespesas = `{{ url_for('main.despesas_detalhes') }}?${params.toString()}`;
            const conhecimentos = {{ summary.faturamento_conhecimentos|tojson if summary and summary.faturamento_conhecimentos else '[]' }};

            const faturamentoCards = document.querySelectorAll('.card[data-type="faturamento"]');
            const despesasCards = document.querySelectorAll('.card[data-type="despesas"]');

            faturamentoCards.forEach(card => card.addEventListener('click', (event) => {
                event.preventDefault();
                btnVerGrafico.onclick = () => { window.location.href = urlGraficoFaturamento; };
                btnAuditar.textContent = '游댌 Auditar Viagens (CT-es)';
                btnAuditar.onclick = () => {
                    choiceModal.style.display = 'none';
                    const container = conhecimentosModal.querySelector('#conhecimentos-lista');
                    container.innerHTML = '';
                    if (conhecimentos && conhecimentos.length > 0) {
                        conhecimentos.forEach(num => {
                            const item = document.createElement('div');
                            item.className = 'conhecimento-item';
                            item.textContent = num;
                            container.appendChild(item);
                        });
                    } else { container.innerHTML = '<p>Nenhum conhecimento encontrado.</p>'; }
                    conhecimentosModal.style.display = 'block';
                };
                choiceModal.style.display = 'block';
            }));

            despesasCards.forEach(card => card.addEventListener('click', (event) => {
                event.preventDefault();
                btnVerGrafico.onclick = () => { window.location.href = urlGraficoDespesas; };
                btnAuditar.textContent = '游댌 Auditar Despesas';
                btnAuditar.onclick = () => {
                    choiceModal.style.display = 'none';
                    const lists = despesasAuditModal.querySelectorAll('.audit-list');
                    lists.forEach(list => list.innerHTML = '<p>Carregando...</p>');
                    despesasAuditModal.style.display = 'block';

                    fetch(`/api/despesas_audit_data?${params.toString()}`)
                        .then(response => response.json())
                        .then(data => {
                            function populateGroupList(containerId, groups) {
                                const container = despesasAuditModal.querySelector('#' + containerId);
                                if (!container) return;
                                container.innerHTML = '';
                                if (groups && Object.keys(groups).length > 0) {
                                    for (const groupName in groups) {
                                        const groupDiv = document.createElement('div');
                                        groupDiv.className = 'audit-group';
                                        const title = document.createElement('h6');
                                        title.textContent = groupName;
                                        groupDiv.appendChild(title);
                                        const keyList = document.createElement('ul');
                                        keyList.className = 'audit-key-list';
                                        groups[groupName].forEach(key => {
                                            const listItem = document.createElement('li');
                                            listItem.textContent = key;
                                            keyList.appendChild(listItem);
                                        });
                                        groupDiv.appendChild(keyList);
                                        container.appendChild(groupDiv);
                                    }
                                } else { container.innerHTML = '<p>Nenhum item encontrado.</p>'; }
                            }
                            populateGroupList('audit-list-custos', data.custos);
                            populateGroupList('audit-list-despesas', data.despesas);
                            populateGroupList('audit-list-tipo-d', data.tipo_d);
                        });
                };
                choiceModal.style.display = 'block';
            }));

            if (conhecimentosModal) {
                conhecimentosModal.addEventListener('click', function(event) {
                    const cteItem = event.target.closest('.conhecimento-item');
                    if (!cteItem) return;

                    const numConhec = cteItem.textContent;
                    const relatorioBody = document.getElementById('relatorio-body');
                    relatorioBody.innerHTML = '<p>Buscando dados da viagem...</p>';
                    relatorioModal.style.display = 'block';

                    fetch(`/api/relatorio_viagem/${numConhec}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                relatorioBody.innerHTML = `<p style="color: red;">Erro: ${data.error}</p>`;
                                return;
                            }
                            let custosHtml = '';
                            for (const [key, value] of Object.entries(data.custos_detalhados)) {
                                custosHtml += `<tr><td>${key}</td><td style="text-align: right;">${value}</td></tr>`;
                            }
                            if (!custosHtml) {
                                custosHtml = '<tr><td colspan="2">Nenhum custo encontrado para esta viagem.</td></tr>';
                            }
                            const dataViagemFmt = data.data_viagem ? new Date(data.data_viagem).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'N/A';
                            relatorioBody.innerHTML = `
                                <div style="text-align: center; margin-bottom: 20px;"><h2>Relat칩rio de Viagem</h2></div>
                                <table class="table table-bordered table-sm">
                                    <tr><th>Viagem (CT-e)</th><td>${data.num_conhec}</td><th>Data Viagem</th><td>${dataViagemFmt}</td></tr>
                                    <tr><th>Ve칤culo</th><td>${data.placa_veiculo || 'N/A'}</td><th>Motorista</th><td>${data.motorista || 'N/A'}</td></tr>
                                </table>
                                <table class="table table-bordered table-sm mt-3">
                                    <tr class="table-secondary"><th colspan="2">Dados da Viagem</th></tr>
                                    <tr><th>Cliente</th><td>${data.cliente || 'N/A'}</td></tr>
                                    <tr><th>Origem &rarr; Destino</th><td>${data.origem || 'N/A'} &rarr; ${data.destino || 'N/A'}</td></tr>
                                    <tr><th>Peso Sa칤da / Chegada</th><td>${data.peso_saida || 0} / ${data.peso_chegada || 0} Kg</td></tr>
                                </table>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <table class="table table-bordered table-sm">
                                            <tr class="table-secondary"><th colspan="2">Receitas</th></tr>
                                            <tr><td>Frete (Valor Bruto)</td><td style="text-align: right;">${data.frete_bruto}</td></tr>
                                            <tr class="table-success" style="font-weight: bold;"><td>TOTAL DAS RECEITAS</td><td style="text-align: right;">${data.total_receitas}</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-bordered table-sm">
                                            <tr class="table-secondary"><th colspan="2">Custos da Viagem</th></tr>
                                            ${custosHtml}
                                            <tr class="table-danger" style="font-weight: bold;"><td>TOTAL DOS CUSTOS</td><td style="text-align: right;">${data.total_custos}</td></tr>
                                        </table>
                                    </div>
                                </div>
                                <table class="table table-bordered table-sm mt-3">
                                    <tr class="table-secondary"><th colspan="2">Resultado da Viagem</th></tr>
                                    <tr style="font-weight: bold;"><td>LUCRO/PREJU칈ZO</td><td style="text-align: right; color: ${data.lucro_prejuizo.includes('-') ? 'red' : 'green'};">${data.lucro_prejuizo}</td></tr>
                                    <tr style="font-weight: bold;"><td>MARGEM (%)</td><td style="text-align: right; color: ${data.margem.includes('-') ? 'red' : 'green'};">${data.margem}</td></tr>
                                </table>
                            `;
                        })
                        .catch(error => {
                            relatorioBody.innerHTML = `<p style="color: red;">Ocorreu um erro ao buscar os dados: ${error}</p>`;
                        });
                });
            }
        }
    });
</script>
{% endblock %}