

{% extends "layout.html" %}

{% block content %}
<style>
    .placa-pr√≥prio { color: #2980B9; font-weight: bold; }
    .placa-terceiro { color: #27AE60; }
    .placa-agregado { color: #F39C12; }
    .placa-apoio { color: #8E44AD; font-style: italic; }

    /* Estilos para os modais */
    .choice-modal-body { text-align: center; padding: 20px; }
    .choice-modal-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
    .choice-modal-buttons button { padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; background-color: #f9f9f9; transition: background-color: 0.2s; }
    .choice-modal-buttons button:hover { background-color: #e9e9e9; }
    .choice-modal-buttons .btn-primary { background-color: #007bff; color: white; border-color: #007bff; }
    .choice-modal-buttons .btn-primary:hover { background-color: #0056b3; }
    
    .conhecimentos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; max-height: 400px; overflow-y: auto; }
    .conhecimento-item { background-color: #f2f2f2; padding: 5px; text-align: center; border-radius: 4px; font-weight: 500; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
    .conhecimento-item:hover { background-color: #d0e3f0; transform: scale(1.05); font-weight: bold; }

    .despesas-audit-modal-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; padding: 15px; }
    .audit-section { border: 1px solid #e0e0e0; border-radius: 5px; padding: 10px; background-color: #f9f9f9; }
    .audit-section h5 { margin-top: 0; padding-bottom: 8px; border-bottom: 1px solid #ccc; font-size: 1em; }
    .audit-list { max-height: 300px; overflow-y: auto; font-size: 0.85em; }
    .audit-group h6 { font-weight: bold; margin-top: 10px; margin-bottom: 5px; }
    .audit-key-list { list-style-type: none; padding-left: 10px; }
    .audit-key-list li { padding: 2px 0; }
</style>

<h1>Dashboard Transporte</h1>

<div class="filters">
    <form method="GET" action="/">
        <div class="filter-item">
            <label for="start_date">Data In√≠cio:</label>
            <input type="date" id="start_date" name="start_date" value="{{ selected_start_date or '' }}">
        </div>
        <div class="filter-item">
            <label for="end_date">Data Fim:</label>
            <input type="date" id="end_date" name="end_date" value="{{ selected_end_date or '' }}">
        </div>
        <div class="filter-item">
            <label for="placa">Placa:</label>
            <select name="placa" id="placa">
                <option value="Todos" {% if 'Todos' == selected_placa %}selected{% endif %}>Todos</option>
                {% for item in placas %}
                    <option value="{{ item.placa }}" class="placa-{{ item.tipo | lower }}" {% if item.placa == selected_placa %}selected{% endif %}>
                        {{ item.placa }} ({{ item.tipo }})
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-item">
            <label for="tipo_negocio">Tipo de Neg√≥cio:</label>
            <select name="tipo_negocio" id="tipo_negocio">
                <option value="Todos" {% if 'Todos' == selected_tipo_negocio %}selected{% endif %}>Todos</option>
                {% for tipo in tipos_negocio %}
                    <option value="{{ tipo }}" {% if tipo == selected_tipo_negocio %}selected{% endif %}>{{ tipo }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-item">
        <label for="filial-multiselect-btn">Filial:</label>
        <div class="multiselect" id="filial-multiselect">
            <button type="button" class="multiselect-btn" id="filial-multiselect-btn">Selecionar Filiais</button>
            <div class="multiselect-dropdown" id="filial-dropdown">
                {% for filial in filiais %}
                    {% if filial != "Todos" %}
                    <div class="multiselect-item">
                        <input type="checkbox" name="filial" value="{{ filial }}" id="filial-{{ loop.index }}" {% if filial in selected_filial %}checked{% endif %}>
                        <label for="filial-{{ loop.index }}">{{ filial }}</label>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
        <div class="filter-item">
            <button type="submit">Aplicar Filtros</button>
        </div>
        <div class="action-buttons">
            <button type="button" id="openUploadModalBtn" class="upload-link">Fazer Upload</button>
            <button type="button" id="openModalBtn" class="manage-link">Gerenciar Grupos</button>
            {% if is_admin_in_context() %}
                <a href="{{ url_for('main.gerenciar_usuarios') }}" class="manage-link">Gerir Utilizadores</a>
            {% endif %}
            <a href="{{ url_for('main.configuracao') }}" class="config-link" style="padding: 8px 12px; background-color: #ffc107; color: black; text-decoration: none; border-radius: 4px; font-weight: 500;">Configurar Rob√¥</a>
            <button type="button" id="btn-iniciar-coleta" class="run-automation-link" style="padding: 8px 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">Atualizar Dados</button>
        </div>
    </form>
</div>

{% if summary %}
<div class="summary-cards">
    <div class="card card-com-link-hover" data-type="faturamento">
        <a href="#" class="link-detalhes-container">Op√ß√µes de An√°lise &rarr;</a>
        <div style="text-decoration: none; color: inherit;">
            <h3>Faturamento Total</h3>
            <p style="color: #2980B9;">{{ summary.faturamento_total_viagens | currency }}</p>
        </div>
    </div>
    <div class="card">
        <h3>Custo Total</h3>
        <p style="color: #E67E22;">{{ summary.custo_total_viagem | currency }}</p>
    </div>
    <div class="card card-com-link-hover" data-type="despesas">
        <a href="#" class="link-detalhes-container">Op√ß√µes de An√°lise &rarr;</a>
        <div style="text-decoration: none; color: inherit;">
            <h3>Despesa Gerais</h3>
            <p style="color: #C0392B;">{{ summary.total_despesas_gerais | currency }}</p>
        </div>
    </div>
    <div class="card">
        {% if placa_filtrada %}
            <h3 title="Valor total de Despesas Tipo D dividido pelo n√∫mero de ve√≠culos pr√≥prios.">Despesa Rateada</h3>
        {% else %}
            <h3>Despesas Tipo D</h3>
        {% endif %}
        <p style="color: #8E44AD;">{{ summary.total_despesas_tipo_d | currency }}</p>
    </div>
    <div class="card">
        <h3>Lucro Liquido</h3>
        <p style="color: {% if summary.saldo_geral >= 0 %}#2ECC71{% else %}#C0392B{% endif %};">{{ summary.saldo_geral | currency }}</p>
    </div>
    <div class="card">
        <h3>Margem Frete</h3>
        <p style="color: {% if summary.margem_frete >= 0 %}#2ECC71{% else %}#C0392B{% endif %};">{{ summary.margem_frete | percentage }}</p>
    </div>
    <div class="card">
        <h3>Contas a Pagar Pendentes</h3>
        <p style="color: #C0392B;">{{ summary.saldo_contas_a_pagar_pendentes | currency }}</p>
    </div>
    <div class="card">
        <h3>Contas a Receber Pendentes</h3>
        <p style="color: #2980B9;">{{ summary.saldo_contas_a_receber_pendentes | currency }}</p>
    </div>
</div>


{% else %}
<p style="text-align: center;">N√£o h√° dados para exibir. Tente importar os dados ou ajustar os filtros.</p>
{% endif %}

<div class="chart-container" id="secao-grafico">
    <h2>Faturamento vs. Despesas (Mensal/Di√°rio)</h2>
    <canvas id="faturamentoDespesasChart"></canvas>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- L√ìGICA GERAL DA P√ÅGINA (SEM ALTERA√á√ïES) ---
    const params = new URLSearchParams(window.location.search);

    const filterForm = document.querySelector('.filters form');
    if (filterForm) {
        filterForm.addEventListener('submit', function(event) {
            const startDateValue = document.getElementById('start_date').value;
            const endDateValue = document.getElementById('end_date').value;
            if (startDateValue && endDateValue && startDateValue > endDateValue) {
                event.preventDefault();
                alert('Aten√ß√£o: A data inicial n√£o pode ser maior que a data final.');
            }
        });
    }
    
    const chartCanvas = document.getElementById('faturamentoDespesasChart');
    if (chartCanvas) {
        fetch(`{{ url_for('api.api_monthly_summary') }}?${params.toString()}`)
            .then(response => response.ok ? response.json() : Promise.reject('Erro de rede'))
            .then(data => {
                const chartContainer = document.getElementById('secao-grafico');
                if (!data || data.length === 0) {
                    if(chartContainer) chartContainer.innerHTML = '<h2>Faturamento vs. Despesas (Mensal/Di√°rio)</h2><p style="text-align: center; padding-top: 20px;">Nenhum dado dispon√≠vel para o per√≠odo selecionado.</p>';
                    return; 
                }
                const labels = data.map(item => item.PeriodoLabel);
                const faturamentoData = data.map(item => item.Faturamento);
                const custoData = data.map(item => item.Custo);
                const despesasGeraisData = data.map(item => item.DespesasGerais);
                new Chart(chartCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Faturamento', data: faturamentoData, backgroundColor: 'rgba(54, 162, 235, 0.7)', stack: 'grupoFaturamento' },
                            { label: 'Custo de Viagem', data: custoData, backgroundColor: 'rgba(255, 159, 64, 0.7)', stack: 'grupoCustos' },
                            { label: 'Despesa Geral', data: despesasGeraisData, backgroundColor: 'rgba(255, 99, 132, 0.7)', stack: 'grupoCustos' }
                        ]
                    },
                    options: { scales: { x: { stacked: false }, y: { stacked: true } } }
                });
            })
            .catch(error => console.error('Erro ao buscar dados para o gr√°fico:', error));
    }

    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        const closeButton = modal.querySelector('.close-button');
        if (closeButton) {
            closeButton.onclick = () => modal.style.display = 'none';
        }
    });
    window.addEventListener('click', (event) => {
        modals.forEach(modal => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    const manageModal = document.getElementById('manageGroupsModal');
    const manageBtn = document.getElementById('openModalBtn');
    if (manageBtn) {
        // Adiciona um √∫nico listener de clique ao cont√™iner da tabela
        document.getElementById('manageGroupsTableContainer').addEventListener('click', function(e) {
            if (e.target.type === 'radio' && e.target.wasChecked) {
                e.target.checked = false;
                e.target.wasChecked = false;
            } else if (e.target.type === 'radio') {
                document.querySelectorAll(`input[name="${e.target.name}"]`).forEach(radio => {
                    radio.wasChecked = false;
                });
                e.target.wasChecked = true;
            }
        });

            manageBtn.onclick = function() {
            const tableContainer = document.getElementById('manageGroupsTableContainer');
            tableContainer.innerHTML = '<p>Sincronizando e carregando grupos...</p>';
            manageModal.style.display = 'block';
            fetch("{{ url_for('main.gerenciar_grupos_dados') }}")
                .then(response => response.json())
                .then(flags => {
                    let tableHTML = `<table class="table table-hover"><thead><tr><th>Nome do Grupo de Despesa</th><th>Classifica√ß√£o</th></tr></thead><tbody>`;
                    for (const group in flags) {
                        const isCustoChecked = flags[group].is_custo_viagem === 'S' ? 'checked' : '';
                        const isDespesaChecked = flags[group].is_despesa === 'S' ? 'checked' : '';
                        const isTipoDChecked = flags[group].incluir_em_tipo_d ? 'checked' : '';
                        const hasTipoD = flags[group].has_tipo_d;
                        const hasTipoV = flags[group].has_tipo_v;
                        let classificationRadios = '';
                        if (hasTipoV || hasTipoD) {
                            classificationRadios = `
                                <label class="form-check-label"><input class="form-check-input" type="radio" name="${group}_class" value="custo_viagem" ${isCustoChecked}> Custo de Viagem</label><br>
                                <label class="form-check-label"><input class="form-check-input" type="radio" name="${group}_class" value="despesa" ${isDespesaChecked}> Despesa Geral</label>
                            `;
                        } else {
                            classificationRadios = '<small class="text-muted">N√£o aplic√°vel</small>';
                        }
                        let tipoDCheckboxHTML = '';
                        if (hasTipoD) {
                            tipoDCheckboxHTML = `<br><label class="form-check-label" style="color: #8E44AD; font-weight: bold;"><input type="checkbox" name="${group}_tipo_d" ${isTipoDChecked}> Contabilizar em Despesa Tipo D</label>`;
                        }
                        tableHTML += `<tr><td>${group}</td><td>${classificationRadios}${tipoDCheckboxHTML}</td></tr>`;
                    }
                    tableHTML += '</tbody></table>';
                    tableContainer.innerHTML = tableHTML;

                    // Marca os bot√µes que j√° v√™m checados para a l√≥gica funcionar corretamente
                    tableContainer.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                        radio.wasChecked = true;
                    });
                });
        };
    }

    const uploadModal = document.getElementById('uploadModal');
    const uploadBtn = document.getElementById('openUploadModalBtn');
    if (uploadBtn) {
        uploadBtn.onclick = () => {
            document.getElementById('uploadForm').reset();
            document.getElementById('uploadFormContainer').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'none';
            uploadModal.style.display = 'block';
        };
    }
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function() {
            document.getElementById('uploadFormContainer').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'block';
        });
    }

    const btnColeta = document.getElementById('btn-iniciar-coleta');
    if (btnColeta) {
        btnColeta.addEventListener('click', function() {
            if (confirm('Isso iniciar√° a busca autom√°tica por novos relat√≥rios. Deseja continuar?')) {
                btnColeta.disabled = true;
                btnColeta.textContent = 'Atualizando...';
                fetch("{{ url_for('main.iniciar_coleta_endpoint') }}", { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.mensagem);
                        if (data.status === 'sucesso') {
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao iniciar a coleta:', error);
                        alert('Ocorreu um erro ao tentar iniciar a coleta.');
                    })
                    .finally(() => {
                        btnColeta.disabled = false;
                        btnColeta.textContent = 'Atualizar Dados';
                    });
            }
        });
    }
    
    const multiselect = document.getElementById('filial-multiselect');
    if (multiselect) {
        const btn = document.getElementById('filial-multiselect-btn');
        const dropdown = document.getElementById('filial-dropdown');
        const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
        function updateButtonText() {
            const checkedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
            const checkedCount = checkedCheckboxes.length;
            if (checkedCount === 0) btn.textContent = 'Selecionar Filiais';
            else if (checkedCount === 1) btn.textContent = checkedCheckboxes[0].value;
            else if (checkedCount === checkboxes.length) btn.textContent = 'Todas as filiais';
            else btn.textContent = `${checkedCount} filiais selecionadas`;
        }
        btn.addEventListener('click', (event) => { dropdown.classList.toggle('show'); event.stopPropagation(); });
        checkboxes.forEach(checkbox => checkbox.addEventListener('change', updateButtonText));
        window.addEventListener('click', (event) => { if (dropdown.classList.contains('show') && !multiselect.contains(event.target)) dropdown.classList.remove('show'); });
        updateButtonText();
    }

    const choiceModal = document.getElementById('choiceModal');
    const conhecimentosModal = document.getElementById('conhecimentosModal');
    const despesasAuditModal = document.getElementById('despesasAuditModal');
    const relatorioModal = document.getElementById('relatorioViagemModal');

    // --- CORRE√á√ïES APLICADAS A PARTIR DAQUI ---
    if (choiceModal && conhecimentosModal && despesasAuditModal && relatorioModal) {
        const btnVerGrafico = choiceModal.querySelector('#btnVerGrafico');
        const btnAuditar = choiceModal.querySelector('#btnAuditar');
        
        const urlGraficoFaturamento = `{{ url_for('main.faturamento_detalhes') }}?${params.toString()}`;
        const urlGraficoDespesas = `{{ url_for('main.despesas_detalhes') }}?${params.toString()}`;
        const conhecimentos = {{ summary.faturamento_conhecimentos|tojson if summary and summary.faturamento_conhecimentos else '[]' }};

        document.querySelectorAll('.card[data-type="faturamento"]').forEach(card => card.addEventListener('click', (event) => {
            event.preventDefault();
            btnVerGrafico.onclick = () => { window.location.href = urlGraficoFaturamento; };
            btnAuditar.textContent = 'üîç Auditar Viagens (CT-es)';
            btnAuditar.onclick = () => {
                choiceModal.style.display = 'none';
                const container = conhecimentosModal.querySelector('#conhecimentos-lista');
                container.innerHTML = '';
                if (conhecimentos && conhecimentos.length > 0) {
                    conhecimentos.forEach(conhecimento => {
                    const item = document.createElement('div');
                    item.className = 'conhecimento-item';
                    item.textContent = conhecimento.display;
                    item.dataset.numero = conhecimento.id;
                    container.appendChild(item);
                });
                } else { container.innerHTML = '<p>Nenhum conhecimento encontrado.</p>'; }
                conhecimentosModal.style.display = 'block';
            };
            choiceModal.style.display = 'block';
        }));

        document.querySelectorAll('.card[data-type="despesas"]').forEach(card => card.addEventListener('click', (event) => {
            event.preventDefault();
            btnVerGrafico.onclick = () => { window.location.href = urlGraficoDespesas; };
            btnAuditar.textContent = 'üîç Auditar Despesas';
            btnAuditar.onclick = () => {
                choiceModal.style.display = 'none';
                despesasAuditModal.querySelectorAll('.audit-list').forEach(list => list.innerHTML = '<p>Carregando...</p>');
                despesasAuditModal.style.display = 'block';
                fetch(`/api/despesas_audit_data?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        function populateGroupList(containerId, groups) {
                            const container = despesasAuditModal.querySelector('#' + containerId);
                            if (!container) return;
                            container.innerHTML = '';
                            if (groups && Object.keys(groups).length > 0) {
                                for (const groupName in groups) {
                                    const groupDiv = document.createElement('div');
                                    groupDiv.className = 'audit-group';
                                    groupDiv.innerHTML = `<h6>${groupName}</h6>`;
                                    const keyList = document.createElement('ul');
                                    keyList.className = 'audit-key-list';
                                    groups[groupName].forEach(key => {
                                        const listItem = document.createElement('li');
                                        listItem.textContent = key;
                                        keyList.appendChild(listItem);
                                    });
                                    groupDiv.appendChild(keyList);
                                    container.appendChild(groupDiv);
                                }
                            } else { container.innerHTML = '<p>Nenhum item encontrado.</p>'; }
                        }
                        populateGroupList('audit-list-custos', data.custos);
                        populateGroupList('audit-list-despesas', data.despesas);
                        populateGroupList('audit-list-tipo-d', data.tipo_d);
                    });
            };
            choiceModal.style.display = 'block';
        }));
        
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) {
                value = 0;
            }
            return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function createItemsTableHtml(title, itemsArray, totalValue, tableClass, numero) {
            const headers = `
                <thead class="table-secondary">
                    <tr>
                        <th style="width: 15%;">Grupo</th><th style="width: 8%;">Nota</th>
                        <th style="width: 10%;">Data</th><th style="width: 5%;">S√©rie</th>
                        <th style="width: 20%;">Fornecedor</th><th style="width: 8%;">C√≥d. Item</th>
                        <th>Descri√ß√£o</th><th class="text-end" style="width: 10%;">Valor</th>
                        <th class="text-center" style="width: 5%;">A√ß√£o</th>
                    </tr>
                </thead>`;
            let rowsHtml = itemsArray.map(item => {
                const showActionButton = item.codItemNota && item.descGrupoD !== 'VALOR QUEBRA' && item.descGrupoD !== 'COMISS√ÉO DE MOTORISTA';
                return `<tr>
                    <td>${item.descGrupoD || ''}</td><td>${item.codNota || ''}</td>
                    <td>${item.dataControle || ''}</td><td>${item.serie || ''}</td>
                    <td>${item.nomeForn || ''}</td><td>${item.codItemNota || ''}</td>
                    <td>${item.descItemD || ''}</td><td class="text-end">${formatCurrency(item.valor_calculado)}</td>
                    <td class="text-center">
                        ${showActionButton ? `<button class="btn btn-warning btn-sm btn-desvincular-despesa" data-numero="${numero}" data-coditemnota="${item.codItemNota}">X</button>` : ''}
                    </td>
                </tr>`;
            }).join('');
            if (!rowsHtml) {
                rowsHtml = `<tr><td colspan="9" class="text-center">Nenhum item encontrado.</td></tr>`;
            }
            const totalHtml = formatCurrency(totalValue);
            return `<h4 class="mt-4">${title}</h4>
                    <table class="table table-bordered table-sm">
                        ${headers}
                        <tbody>${rowsHtml}</tbody>
                        <tfoot><tr class="${tableClass}" style="font-weight: bold;"><td colspan="8" class="text-end">TOTAL</td><td class="text-end">${totalHtml}</td></tr></tfoot>
                    </table>`;
        }

       function createSugestoesTableHtml(sugestoes, numero) {
    if (!sugestoes || sugestoes.length === 0) {
        return '<div class="no-print"><h4>Nenhuma despesa sugerida encontrada.</h4></div>';
    }
    let totalSugestoes = 0;
    const headers = `
        <thead class="table-light">
            <tr>
                <th>Grupo</th><th>Nota</th><th>Data</th><th>S√©rie</th>
                <th>Fornecedor</th><th>C√≥d. Item</th><th>Descri√ß√£o</th>
                <th style="text-align: right;">Valor</th><th>A√ß√£o</th>
            </tr>
        </thead>`;
    let rowsHtml = sugestoes.map(item => {
        totalSugestoes += parseFloat(item.Valor) || 0;
        return `<tr>
            <td>${item.descGrupoD || ''}</td><td>${item.codNota || ''}</td>
            <td>${item.dataControle || ''}</td><td>${item.serie || ''}</td>
            <td>${item.nomeForn || ''}</td><td>${item.codItemNota || ''}</td>
            <td>${item.descItemD || ''}</td><td style="text-align: right;">${formatCurrency(item.Valor)}</td>
            <td><button class="btn btn-success btn-sm btn-adicionar-despesa" data-numero="${numero}" data-coditemnota="${item.codItemNota}">Adicionar</button></td>
        </tr>`;
    }).join('');
    const footer = `
        <tfoot>
            <tr style="font-weight: bold;">
                <td colspan="8" style="text-align: right;">TOTAL DAS SUGEST√ïES</td>
                <td style="text-align: right;">${formatCurrency(totalSugestoes)}</td>
                <td></td>
            </tr>
        </tfoot>`;

    // A CORRE√á√ÉO EST√Å AQUI: a div 'no-print' envolve todo o conte√∫do.
    return `<div class="no-print">
                <h4 class="mt-4">Despesas Sugeridas (N√£o Vinculadas)</h4>
                <p><small>Despesas da mesma placa na janela de dias selecionada que ainda n√£o foram associadas a nenhum CT-e.</small></p>
                <table class="table table-bordered table-sm">
                    ${headers}
                    <tbody>${rowsHtml}</tbody>
                    ${footer}
                </table>
            </div>`;
}
        function fetchAndRenderReport(numero) {
            const relatorioBody = document.getElementById('relatorio-body');
            relatorioBody.innerHTML = '<p class="text-center">Buscando dados da viagem...</p>';
            relatorioModal.querySelector('#btnPrintReport').dataset.numero = numero;
            relatorioModal.style.display = 'block';

            const diasBusca = document.getElementById('dias-busca-sugestao').value || 10;
            const apiUrl = `{{ url_for('api.api_relatorio_viagem', numero=0) }}`.replace('0', numero) + `?dias_janela=${diasBusca}`;

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) { throw new Error(`Erro de rede: ${response.statusText}`); }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        relatorioBody.innerHTML = `<p class="text-center text-danger">Erro: ${data.error}</p>`;
                        return;
                    }
                    const dataViagemFmt = data.data_viagem ? new Date(data.data_viagem).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'N/A';
                    const receitasHtml = `<table class="table table-bordered table-sm mt-3">
                        <tr class="table-secondary"><th colspan="2">Receitas</th></tr>
                    <tr><td>Frete (Valor Bruto)</td><td class="text-end">${formatCurrency(data.frete_bruto)}</td></tr>
                    <tr><td>Ped√°gio</td><td class="text-end">${formatCurrency(data.valor_pedagio)}</td></tr>
                    <tr>
                        <td colspan="2" style="font-size: 0.75em; color: red; text-align: center; border: none; padding-top: 0;">
                            * O valor do ped√°gio s√≥ √© somado ao total se a flag 'pedagioEmbutidoFrete' for 'N'.
                        </td>
                    </tr>
                    <tr class="table-success" style="font-weight: bold;"><td>TOTAL</td><td class="text-end">${formatCurrency(data.total_receitas)}</td></tr>
                </table>`;
                    const custosHtml = createItemsTableHtml('Outros Custos da Viagem', data.custos_detalhados, data.total_outros_custos, 'table-warning', numero);
                    const despesasHtml = createItemsTableHtml('Despesas da Viagem', data.despesas_detalhadas, data.total_despesas, 'table-danger', numero);
                    const sugestoesHtml = createSugestoesTableHtml(data.despesas_sugeridas, numero);
                    const resultadoHtml = `
                        <table class="table table-bordered table-sm mt-3">
                        <tr class="table-secondary"><th colspan="2">Resultado da Viagem</th></tr>
                        <tr><td>Frete Bruto Recebido</td><td class="text-end">${formatCurrency(data.frete_bruto)}</td></tr>
                        <tr><td>(-) Valor Quebra</td><td class="text-end text-danger">${formatCurrency(data.valor_quebra)}</td></tr>
                        <tr><td>(-) Comiss√£o Motorista</td><td class="text-end text-danger">${formatCurrency(data.comissao_motorista)}</td></tr>
                        <tr><td>(-) Total Outros Custos</td><td class="text-end text-danger">${formatCurrency(data.total_outros_custos)}</td></tr>
                        <tr><td>(-) Total Despesas da Viagem</td><td class="text-end text-danger">${formatCurrency(data.total_despesas)}</td></tr>
                        <tr><td>(-) Outros Descontos</td><td class="text-end text-danger">${formatCurrency(data.outros_descontos)}</td></tr>
                        <tr style="font-weight: bold;">
                            <td>LUCRO/PREJU√çZO</td>
                            <td class="text-end" style="color: ${data.lucro_prejuizo_valor < 0 ? 'red' : 'green'};">${formatCurrency(data.lucro_prejuizo_valor)}</td>
                        </tr>
                        <tr style="font-weight: bold;">
                            <td>MARGEM (%)</td>
                            <td class="text-end" style="color: ${data.margem_valor < 0 ? 'red' : 'green'};">${(data.margem_valor || 0).toFixed(2).replace('.', ',')}%</td>
                        </tr>
                    </table>`;
                    relatorioBody.innerHTML = `
                        <div class="text-center mb-3"><h2>Relat√≥rio de Viagem</h2></div>
                        
                                                <table class="table table-bordered table-sm">
                            <tr>
                                <th style="width: 25%;">Viagem (CT-e)</th><td style="width: 25%;">${data.viagem_display}</td>
                                <th style="width: 25%;">Data Viagem</th><td style="width: 25%;">${dataViagemFmt}</td>
                            </tr>
                            <tr>
                                <th>Ve√≠culo</th><td>${data.placa_veiculo || 'N/A'}</td>
                                <th>Motorista</th><td>${data.motorista || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>Numero Nota</th><td>${data.numero_nota}</td>
                                <th>Filial</th><td>${data.filial}</td>
                            </tr>
                            <tr>
                                <th>Unidade de Embarque</th><td colspan="3">${data.unidade_embarque}</td>
                            </tr>
                        </table>

                        <table class="table table-bordered table-sm mt-3">
                            <tr class="table-secondary"><th colspan="2">Dados da Viagem</th></tr>
                            <tr><th>Cliente</th><td>${data.cliente || 'N/A'}</td></tr>
                            <tr><th>Origem &rarr; Destino</th><td>${data.origem || 'N/A'} &rarr; ${data.destino || 'N/A'}</td></tr>
                            <tr><th>Peso Sa√≠da / Chegada</th><td>${(data.peso_saida || 0).toLocaleString('pt-BR')} / ${(data.peso_chegada || 0).toLocaleString('pt-BR')} Kg</td></tr>
                            <tr><th>Valor Seguro</th><td>${formatCurrency(data.valor_seguro)}</td></tr>
                            <tr><th>KM Inicial</th><td>${(data.km_inicial || 0).toLocaleString('pt-BR')}</td></tr>
                            <tr><th>KM Final</th><td>${(data.km_final || 0).toLocaleString('pt-BR')}</td></tr>
                            <tr><th>KM Rodado</th><td>${(data.km_rodado || 0).toLocaleString('pt-BR')} Km</td></tr>
                            <tr><th>Porcentagem Comiss√£o</th><td>${(data.comissao_perc || 0).toLocaleString('pt-BR')}% (Base: ${formatCurrency(data.valor_base_comissao)})</td></tr>
                        </table>

                        ${receitasHtml}
                        ${custosHtml}
                        ${despesasHtml}
                        ${resultadoHtml}
                        ${sugestoesHtml}`;
                    })
                .catch(error => {
                    relatorioBody.innerHTML = `<p class="text-center text-danger">Ocorreu um erro ao buscar os dados: ${error}</p>`;
                });
        }

       conhecimentosModal.addEventListener('click', function(event) {
            const cteItem = event.target.closest('.conhecimento-item');
            if (cteItem && cteItem.dataset.numero) {
                fetchAndRenderReport(cteItem.dataset.numero);
            }
        const btnPrint = relatorioModal.querySelector('#btnPrintReport');
        if (btnPrint) {
            btnPrint.addEventListener('click', function() {
                const numeroViagem = this.dataset.numero; // Pega o n√∫mero guardado
                if (numeroViagem) {
                    const printUrl = `/report/print/${numeroViagem}`;
                    window.open(printUrl, '_blank'); // Abre o PDF num novo separador
                } else {
                    alert('Erro: N√£o foi poss√≠vel identificar o n√∫mero da viagem para impress√£o.');
                }
            });
        }    
        });

        relatorioModal.addEventListener('click', function(event) {
            const button = event.target.closest('button');
            if (!button || (!button.classList.contains('btn-adicionar-despesa') && !button.classList.contains('btn-desvincular-despesa'))) return;

            const numero = button.dataset.numero;
            const codItemNota = button.dataset.coditemnota;
            const isAdd = button.classList.contains('btn-adicionar-despesa');
            const apiUrl = isAdd ? "{{ url_for('api.associar_despesa_viagem') }}" : "{{ url_for('api.desvincular_despesa_viagem') }}";
            
            button.disabled = true;
            button.textContent = isAdd ? '...' : 'X';

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numero: numero, cod_item_nota: codItemNota })
            })
            .then(response => {
                if (!response.ok) { 
                    alert('Erro de comunica√ß√£o com o servidor.');
                    return Promise.reject('API falhou');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    fetchAndRenderReport(numero);
                } else {
                    alert('Erro: ' + (data.message || 'A√ß√£o falhou'));
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error("Erro na a√ß√£o da despesa:", error);
                button.disabled = false;
            });
        });
    }

    const filtroConhecimentoInput = document.getElementById('filtro-conhecimento');
    if (filtroConhecimentoInput) {
        filtroConhecimentoInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const conhecimentosGrid = document.getElementById('conhecimentos-lista');
            const todosOsItens = conhecimentosGrid.querySelectorAll('.conhecimento-item');

            todosOsItens.forEach(function(item) {
                const itemText = item.textContent.toLowerCase();
                if (itemText.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
});
</script>
{% endblock %}