<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações do Robô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .tab-content {
            padding: 2rem 1.5rem;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 .375rem .375rem;
            background-color: #fff;
        }
        #log-table-container {
            background-color: #212529;
            border-radius: 5px;
            height: 600px;
            overflow-y: auto;
            margin-top: 1rem;
            border: 1px solid #495057;
        }
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
        }
        .log-table th, .log-table td {
            padding: 8px 12px;
            text-align: left;
            color: #ced4da;
            vertical-align: top;
            border-bottom: 1px solid #343a40;
        }
        .log-table th {
            background-color: #343a40;
            position: sticky;
            top: 0;
            color: #fff;
        }
        .log-table td:first-child {
            white-space: nowrap;
            color: #8495a6;
            width: 180px;
        }
        .log-table tr.separator-row td {
            text-align: center;
            font-weight: bold;
            color: #0d6efd;
            background-color: #2c3136;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Configurações do Robô de Coleta</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">Fechar</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('configuracao') }}">
            <ul class="nav nav-tabs" id="configTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="conexao-tab" data-bs-toggle="tab" data-bs-target="#conexao-pane" type="button">Conexão SAT</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="parametros-tab" data-bs-toggle="tab" data-bs-target="#parametros-pane" type="button">Parâmetros (Códigos)</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="periodo-tab" data-bs-toggle="tab" data-bs-target="#periodo-pane" type="button">Período de Exportação</button>
                </li>
            </ul>

            <div class="tab-content" id="configTabContent">
                <div class="tab-pane fade show active" id="conexao-pane" role="tabpanel">
                    <div class="form-group mb-3"><label for="URL_LOGIN">Link do Site (URL)</label><input type="text" class="form-control" id="URL_LOGIN" name="URL_LOGIN" value="{{ configs.get('URL_LOGIN', '') }}"></div>
                    <div class="form-group mb-3"><label for="USUARIO_ROBO">Usuário</label><input type="text" class="form-control" id="USUARIO_ROBO" name="USUARIO_ROBO" value="{{ configs.get('USUARIO_ROBO', '') }}"></div>
                    <div class="form-group mb-3"><label for="SENHA_ROBO">Senha</label><input type="password" class="form-control" id="SENHA_ROBO" name="SENHA_ROBO" value="{{ configs.get('SENHA_ROBO', '') }}"></div>
                </div>
                <div class="tab-pane fade" id="parametros-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6"><div class="form-group mb-3"><label for="CODIGO_VIAGENS_CLIENTE">Base: Viagens por Cliente</label><input type="text" class="form-control" name="CODIGO_VIAGENS_CLIENTE" value="{{ configs.get('CODIGO_VIAGENS_CLIENTE', '') }}"></div></div>
                        <div class="col-md-6"><div class="form-group mb-3"><label for="CODIGO_VIAGENS_FAT_CLIENTE">Base: Fat.Viagens por Cliente</label><input type="text" class="form-control" name="CODIGO_VIAGENS_FAT_CLIENTE" value="{{ configs.get('CODIGO_VIAGENS_FAT_CLIENTE', '') }}"></div></div>
                        <div class="col-md-6"><div class="form-group mb-3"><label for="CODIGO_CONTAS_PAGAR">Base: Conta a Pagar/Pagas</label><input type="text" class="form-control" name="CODIGO_CONTAS_PAGAR" value="{{ configs.get('CODIGO_CONTAS_PAGAR', '') }}"></div></div>
                        <div class="col-md-6"><div class="form-group mb-3"><label for="CODIGO_CONTAS_RECEBER">Base: Conta Rec/Recebidas</label><input type="text" class="form-control" name="CODIGO_CONTAS_RECEBER" value="{{ configs.get('CODIGO_CONTAS_RECEBER', '') }}"></div></div>
                        <div class="col-md-6"><div class="form-group mb-3"><label for="CODIGO_DESPESAS">Base: Despesas Contas a Pagar</label><input type="text" class="form-control" name="CODIGO_DESPESAS" value="{{ configs.get('CODIGO_DESPESAS', '') }}"></div></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="periodo-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="DATA_INICIAL_ROBO">Data Inicial</label>
                                <input type="date" class="form-control" id="DATA_INICIAL_ROBO" name="DATA_INICIAL_ROBO" value="{{ configs.get('DATA_INICIAL_ROBO_YMD', '') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="DATA_FINAL_ROBO">Data Final</label>
                                <input type="date" class="form-control" id="DATA_FINAL_ROBO" name="DATA_FINAL_ROBO" value="{{ configs.get('DATA_FINAL_ROBO_YMD', '') }}">
                            </div>
                        </div>
                    </div>
                    <div class="form-check form-switch mt-4">
                      <input class="form-check-input" type="checkbox" id="live_monitoring_enabled" name="live_monitoring_enabled" {% if configs.get('live_monitoring_enabled') %}checked{% endif %}>
                      <label class="form-check-label" for="live_monitoring_enabled">
                          Ativar coleta em tempo real (a cada X minutos enquanto o dashboard estiver aberto)
                         </label>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-success">Salvar Configurações</button>
            </div>
        </form>

        <div class="card mt-5">
            <div class="card-header h5">Visualizador de Logs do Robô</div>
            <div class="card-body">
                <div class="log-actions">
                    <button id="loadLogsBtn" type="button" class="btn btn-primary">
                        <span id="btn-text-load">Carregar Logs</span>
                    </button>
                    <button id="clearLogsBtn" type="button" class="btn btn-danger">
                        <span id="btn-text-clear">Limpar Logs</span>
                    </button>
                </div>
                <div id="log-table-container">
                    <table class="log-table">
                        <thead>
                            <tr><th>Horário</th><th>Mensagem</th></tr>
                        </thead>
                        <tbody id="logs-body">
                            <tr><td colspan="2" style="text-align:center; color: #888;">Clique em "Carregar Logs" para começar.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // LÓGICA DE LOGS (Carregamento contínuo)
            const loadLogsBtn = document.getElementById('loadLogsBtn');
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            const logsBody = document.getElementById('logs-body');
            const logTableContainer = document.getElementById('log-table-container');
            const btnTextLoad = document.getElementById('btn-text-load');
            const btnTextClear = document.getElementById('btn-text-clear');
            let logInterval = null;

            function fetchAndRenderLogs() {
                fetch('/api/get_robot_logs')
                    .then(response => response.ok ? response.json() : Promise.reject('Erro de rede'))
                    .then(logs => {
                        logsBody.innerHTML = '';
                        if (logs.length === 0) {
                            logsBody.innerHTML = `<tr><td colspan="2" style="text-align:center; color: #888;">Nenhum log encontrado.</td></tr>`;
                            return;
                        }
                        logs.reverse();
                        logs.forEach((log, index) => {
                            if (log.mensagem.includes('--- INICIANDO') && index > 0) {
                                const sepRow = logsBody.insertRow();
                                sepRow.className = 'separator-row';
                                const sepCell = sepRow.insertCell();
                                sepCell.colSpan = 2;
                                sepCell.textContent = `--- Nova Execução ---`;
                            }
                            const logRow = logsBody.insertRow();
                            const timeCell = logRow.insertCell();
                            const msgCell = logRow.insertCell();
                            timeCell.textContent = log.timestamp;
                            msgCell.innerHTML = log.mensagem.includes('--- INICIANDO') ? `<strong>${log.mensagem}</strong>` : log.mensagem;
                        });
                        logTableContainer.scrollTop = logTableContainer.scrollHeight;
                    })
                    .catch(error => {
                        console.error('Erro ao buscar logs:', error);
                        logsBody.innerHTML = `<tr><td colspan="2" style="color: #dc3545;">Falha ao carregar logs.</td></tr>`;
                        stopLogPolling();
                    });
            }

            function stopLogPolling() {
                if (logInterval) {
                    clearInterval(logInterval);
                    logInterval = null;
                    btnTextLoad.textContent = 'Carregar Logs';
                    loadLogsBtn.classList.remove('btn-danger');
                    loadLogsBtn.classList.add('btn-primary');
                }
            }
            
            loadLogsBtn.addEventListener('click', function () {
                if (logInterval) {
                    stopLogPolling();
                } else {
                    btnTextLoad.textContent = 'Parar Atualização';
                    loadLogsBtn.classList.remove('btn-primary');
                    loadLogsBtn.classList.add('btn-danger');
                    fetchAndRenderLogs();
                    logInterval = setInterval(fetchAndRenderLogs, 7000);
                }
            });

            clearLogsBtn.addEventListener('click', function() {
                if (!confirm('Tem certeza? Esta ação apagará TODOS os logs.')) return;
                stopLogPolling();
                btnTextClear.textContent = 'Limpando...';
                clearLogsBtn.disabled = true;
                
                fetch('/api/clear_robot_logs', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            logsBody.innerHTML = `<tr><td colspan="2" style="text-align:center; color: #28a745;">Logs limpos com sucesso!</td></tr>`;
                        } else {
                            alert(`Erro ao limpar os logs: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao limpar logs:', error);
                        alert('Falha ao comunicar com o servidor.');
                    })
                    .finally(() => {
                        btnTextClear.textContent = 'Limpar Logs';
                        clearLogsBtn.disabled = false;
                    });
            });
        });
    </script>
</body>
</html>

